# Ch.4 ì½”ë“œë¡œ ê°œë°œí•˜ëŠ” ì»¨í…Œì´ë„ˆ ì¸í”„ë¼, Dockerfile

## 4.1.1 IaCì™€ Dockerfile

- `Dockerfile`: ì›í•˜ëŠ” ê°œë°œí™˜ê²½ì„ ì½”ë“œë¡œ êµ¬ì„±í•˜ëŠ” ë°©ë²•(Infrastructure as Code, IaC)
- IaCëŠ” ì™œ í•„ìš”í• ê¹Œ?
    - ì»¤ë§¨ë“œ ê¸°ë°˜ ì¸í”„ë¼ êµ¬ì„± â†’ ì¸ì  ì˜¤ë¥˜ ê°€ëŠ¥ì„± ë†’ìŒ(ë§¤ë²ˆ ëª…ë ¹ì–´ ì³ì•¼ í•˜ë‹ˆ)
    - ì„¤ì¹˜ ìˆœì„œ, ìƒí˜¸ ì—°ê´€ì„±ì„ ê³ ë ¤í•´ì•¼ í•˜ëŠ” ë¬¸ì œ í•´ê²°
- ì´ëŸ¬í•œ ìˆ˜ê³ ë¡œì›€ì„ í•˜ë‚˜ì˜ ì´ë¯¸ì§€ë¡œ ë§Œë“¤ì–´ë‘ê³ , ìˆ˜ì •ì‚¬í•­ì€ ì–¸ì œë“  ì½”ë“œ ë³€ê²½ì´ ìš©ì´í•˜ë‹¤ë©´ ê°œë°œ ì—…ë¬´ ëª©ì ì—ë§Œ ì˜¨ì „íˆ ì§‘ì¤‘í•  ìˆ˜ ìˆë‹¤.
- í”„ë¡œê·¸ë˜ë°í˜• ì¸í”„ë¼ ê°œë°œì€ íƒ„ë ¥ì„±, í™•ì¥ì„±, ë°˜ë³µì„±ì„ ë¶€ì—¬í•´ ë™ì¼í•œ í™˜ê²½ ì„œë²„ë¥¼ ìˆ˜ì‹­-ìˆ˜ë°± ëŒ€ê¹Œì§€ ìš´ì˜, ê´€ë¦¬í•´ì¤€ë‹¤.
- Dockerfile: ì½”ë“œë¡œì„œ ì¸í”„ë¼ í™˜ê²½ì„ í”„ë¡œë¹„ì €ë‹ â†’ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì ìš©ë˜ëŠ” ìƒˆë¡œìš´ í™˜ê²½ì„ ì‚¬ìš©ìê°€ ì§ì ‘ ì •ì˜í•´ì„œ ì•„ì´ë””ì–´ë¥¼ ì‹¤í˜„í•  ìˆ˜ ìˆìŒ

## 4.1.2 ìµœì ì˜ Dockerfile ë§Œë“¤ê¸°

- ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ ì‹œìŠ¤í…œ ì—­í• ì„ í•˜ëŠ” ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ë ¤ë©´ Dockerfileì´ë¼ëŠ” ì´ë¯¸ì§€ ë¹Œë“œìš© DSL(Domain Specific Language, ë„ë©”ì¸ íŠ¹í™” ì–¸ì–´) íŒŒì¼ì„ ì‚¬ìš©í•œë‹¤. íŠ¹ì • ì»¨í…Œì´ë„ˆë¥¼ ìœ„í•œ ì´ë¯¸ì§€ë¥¼ ê°œë°œí•  ê²½ìš° í•„ìš”í•œ ëª¨ë“  ì„¤ì • ë‚´ìš©ì„ ë‹´ì€ íŒŒì¼ì´ë‹¤.
- Dockerfile ê¸°ì¤€
    - ê²½ëŸ‰ì˜ ì»¨í…Œì´ë„ˆ ì„œë¹„ìŠ¤ ì œê³µ
    - Dockerfileì— ë‹´ê¸°ëŠ” ë ˆì´ì–´ ìµœì†Œí™”
    - í•˜ë‚˜ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ í•˜ë‚˜ì˜ ì»¨í…Œì´ë„ˆì—
    - ìºì‹œ ê¸°ëŠ¥ í™œìš©
    - IaC í™˜ê²½ ê°œë°œì€ ë””ë ‰í† ë¦¬ ë‹¨ìœ„ë¡œ
    - ì„œë²„ë¦¬ìŠ¤ í™˜ê²½ìœ¼ë¡œ ê°œë°œ

# 4.2 Dockerfile ëª…ë ¹ì–´ì™€ ì´ë¯¸ì§€ ë¹Œë“œ

- ë„ì»¤ëŠ” ê°œë°œí™˜ê²½ì˜ ì»¨í…Œì´ë„ˆí™” í‘œì¤€

## 4.2.1 Dockerfile ëª…ë ¹ì–´

- Dockerfile: ê°œë°œí™˜ê²½ì„ ì œê³µí•˜ê¸° ìœ„í•œ ì—¬ëŸ¬ ê°€ì§€ ëª…ë ¹ì–´ë“¤ì˜ ì§‘í•©ì²´(17ê°œ ë‚´ì™¸)
    - `FROM` : ìƒì„±í•˜ë ¤ëŠ” ì´ë¯¸ì§€ì˜ ë² ì´ìŠ¤ ì´ë¯¸ì§€ë¥¼ ì§€ì •
        - ë„ì»¤ í—ˆë¸Œì—ì„œ ì œê³µí•˜ëŠ” ê³µì‹ ì´ë¯¸ì§€ë¥¼ ê¶Œì¥
        - `FROM` ubuntu:20.04
    - `RUN`: ì„¤ì •ëœ ê¸°ë³¸ ì´ë¯¸ì§€ì— íŒ¨í‚¤ì§€ ì„¤ì¹˜, ëª…ë ¹ ì‹¤í–‰ ë“±ì„ ì‘ì„±(1ê°œ ì´ìƒ ì‘ì„± ê°€ëŠ¥)
        - ë‹¤ë‹¨ê³„ ë¹Œë“œ ì‚¬ìš© ê¶Œì¥, ê° ì´ë¯¸ì§€ë³„ë¡œ ê°œë³„ Dockerfileë¡œ ë¹Œë“œ
    - `CMD` : ìƒì„±ëœ ì´ë¯¸ì§€ë¥¼ ì»¨í…Œì´ë„ˆë¡œ ì‹¤í–‰í•  ë•Œ ì‹¤í–‰ë˜ëŠ” ëª…ë ¹ì–´
        - `ENTRYPOINT` ëª…ë ¹ë¬¸ìœ¼ë¡œ ì§€ì •ëœ ì»¤ë§¨ë“œì— ë””í´íŠ¸ë¡œ ë„˜ê¸¸ íŒŒë¼ë¯¸í„°ë¥¼ ì§€ì •í•  ë•Œ ì‚¬ìš©.
    - `ENTRYPOINT`: CMDì™€ ë§ˆì°¬ê°€ì§€ë¡œ ìƒì„±ëœ ì´ë¯¸ì§€ê°€ ì»¨í…Œì´ë„ˆë¡œ ì‹¤í–‰ë  ë•Œ ì‚¬ìš©ë˜ì§€ë§Œ ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë  ë•Œ ëª…ë ¹ì–´ ë° ì¸ì ê°’ì„ ì „ë‹¬í•˜ì—¬ ì‹¤í–‰í•˜ëŠ” ì ì´ ë‹¤ë¥´ë‹¤.
        - CMDì™€ ìœ ì‚¬í•˜ë‚˜ ì¸ì ê°’ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ì— ìœ ìš©í•¨
        - `ENTRYPOINT [â€npmâ€, â€œstartâ€]`
    - `COPY`: í˜¸ìŠ¤íŠ¸ í™˜ê²½ì˜ íŒŒì¼, ë””ë ‰í„°ë¦¬ë¥¼ ì´ë¯¸ì§€ ì•ˆì— ë³µì‚¬í•˜ëŠ” ê²½ìš° ì‘ì„±
        - ë‹¨ìˆœí•œ ë³µì‚¬ ì‘ì—…ë§Œ ì§€ì›í•˜ë©° ë¹Œë“œ ì‘ì—… ë””ë ‰í† ë¦¬ ì™¸ë¶€ íŒŒì¼ì€ COPYí•  ìˆ˜ ì—†ìŒ.
    - `ADD`:í˜¸ìŠ¤íŠ¸ í™˜ê²½ì˜ íŒŒì¼, ë””ë ‰í† ë¦¬ë¥¼ ì´ë¯¸ì§€ ì•ˆì— ë³µì‚¬í•˜ëŠ” ê²½ìš°ë¿ë§Œ ì•„ë‹ˆë¼ URL ì£¼ì†Œì—ì„œ ì§ì ‘ ë‹¤ìš´ë¡œë“œí•´ ì´ë¯¸ì§€ì— ë„£ì„ ìˆ˜ë„ ìˆê³ , ì••ì¶• íŒŒì¼ì¸ ê²½ìš°ì—ëŠ” ê²½ë¡œì— ì••ì¶• í’€ì–´ì„œ ì¶”ê°€
    - `ENV`:ì´ë¯¸ì§€ ì•ˆì— ê°ì¢… í™˜ê²½ ë³€ìˆ˜ë¥¼ ì§€ì •í•˜ëŠ” ê²½ìš° ì‘ì„±
    - `EXPOSE`:ì»¨í…Œì´ë„ˆê°€ í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ ë“¤ì–´ì˜¤ëŠ” íŠ¸ë˜í”½ì„ ë¦¬ìŠ¤ë‹í•˜ëŠ” í¬íŠ¸ì™€ í”„ë¡œí† ì½œì„ ì§€ì •í•˜ê¸° ìœ„í•´ ì‘ì„±
    - `WORKDIR`:ì»¨í…Œì´ë„ˆìƒì—ì„œ ì‘ì—…í•  ê²½ë¡œ ì „í™˜ì„ ìœ„í•´ ì‘ì„±. WORKDIRì„ ì„¤ì •í•˜ë©´ RUN, CMD, ENTRYPOINT, COPY, ADD ëª…ë ¹ë¬¸ì€ í•´ë‹¹ ë””ë ‰í† ë¦¬ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‹¤í–‰.
- ì¼ë°˜ì ìœ¼ë¡œ FROM ëª…ë ¹ì–´ë¶€í„° ì‘ì„±í•˜ì§€ë§Œ ê·¸ë‹¤ìŒ ëª…ë ¹ë¶€í„°ëŠ” ìˆœì„œê°€ ì—†ìŒ. í•˜ì§€ë§Œ ëª…ë ¹ ìˆœì„œê°€ ë¹Œë“œ ìºì‹œ ë¬´íš¨í™”ì™€ ì—°ê´€ë˜ë¯€ë¡œ ë³€ê²½ ë¹ˆë„ìˆ˜ê°€ ì ì€ ëª…ë ¹ì„ ë¨¼ì € ë°°ì¹˜í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•œë‹¤.

## 4.2.2 ì´ë¯¸ì§€ ìƒì„±ì„ ìœ„í•œ Dockerfile ë¹Œë“œ

### ì´ë¯¸ì§€ ë¹Œë“œ

- docker build ëª…ë ¹ìœ¼ë¡œ Dockerfileë¡œë¶€í„° ì´ë¯¸ì§€ ìƒì„± ê°€ëŠ¥
1. ì˜µì…˜
    - `-t`: â€œì´ë¯¸ì§€ëª…:íƒœê·¸â€ë¥¼ ì§€ì •í•˜ëŠ” ê²½ìš°
        - ë™ì‹œì— ì—¬ëŸ¬ ì €ì¥ì†Œ ìƒì„±í•˜ë ¤ë©´ -t ë°˜ë³µ ê°€ëŠ¥
    - `-f`: Dockerfileì´ ì•„ë‹Œ ë‹¤ë¥¸ íŒŒì¼ëª… ì‚¬ìš©í•˜ëŠ” ê²½ìš°
2. ì´ë¯¸ì§€ëª…:[íƒœê·¸]
    - ìƒì„±í•  ì´ë¯¸ì§€ ì´ë¦„ê³¼ íƒœê·¸ ì§€ì •
    - ì¼ë°˜ì ìœ¼ë¡œ íƒœê·¸ëŠ” ë²„ì „ ê´€ë¦¬ ì°¨ì›ìœ¼ë¡œ ê³ ë ¤
3. ê²½ë¡œ
    - ë””ë ‰í„°ë¦¬ ë‹¨ìœ„ ê°œë°œì„ ê¶Œê³ . í˜„ì¬ ê²½ë¡œì— Dockerfileì´ ìˆë‹¤ë©´ â€œ.â€ ì‚¬ìš©.

### ì™œ Dockerfileì´ í•„ìš”í• ê¹Œ?

- ì„œë²„ë¦¬ìŠ¤ í™˜ê²½ì„ ê°œë°œí•  ìˆ˜ ìˆëŠ” Dockerfile â†’ë°˜ë³µì ì´ê³  ìˆ˜ê³ ë¡œìš´ ì‘ì—… ìë™í™”

> ğŸ’¡ ì´ë²ˆ ì‹¤ìŠµë¶€í„°ëŠ” AWS EC2ë¥¼ í™œìš©í•´ ìš°ë¶„íˆ¬ í™˜ê²½ì—ì„œ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤ ğŸ™‚
> - AWS EC2 ì ‘ì† ë°©ë²•
> - [ë„ì»¤ ì„¤ì¹˜ on Ubuntu22.04](https://bundw.tistory.com/98)


```bash
ubuntu@ip-...-..-.-...:~$ sudo apt update
...
# apache2 ì„¤ì¹˜
ubuntu@ip-...-..-.-...:~$ sudo apt -y install apache2

# netstat ëª…ë ¹ì–´ ì‚¬ìš©í•˜ê¸° ìœ„í•´ net-tools ì„¤ì¹˜
ubuntu@ip-...-..-.-...:~$ sudo apt install net-tools
...
ubuntu@ip-...-..-.-...:~$ sudo netstat -nlp | grep 80
tcp6       0      0 :::80                   :::*                    LISTEN      2713/apache2

# apache2 ì‹¤í–‰
ubuntu@ip-...-..-.-...:~$ sudo service apache2 start
ubuntu@ip-...-..-.-...:~$ sudo service apache2 service
Usage: apache2 {start|stop|graceful-stop|restart|reload|force-reload}

# ip ì£¼ì†Œë¡œ ì ‘ì†

```

![img.png](img.png)

```bash
ubuntu@ip-...-..-.-...:/var/www/html$ sudo mv index.html index.html.org
ubuntu@ip-...-..-.-...:/var/www/html$ sudo vi index.html
ubuntu@ip-...-..-.-...:/var/www/html$ curl localhost:80
<h1> Welcome to my webserver! </h1>

...
ubuntu@ip-...-..-.-...:/var/www/html$ sudo vi index.php
...
<?php
    phpinfo();
?>
...

```

![img_1.png](img_1.png)

â‡’ ì´ ì‘ì—…ì„ ë„ì»¤ íŒŒì¼ë¡œ í•˜ë©´ ì–´ë–»ê²Œ ë ê¹Œ?

<aside>
ğŸ’¡ `sudo chmod 666 /var/run/docker.sock` â†’

</aside>

```bash
ubuntu@ip-...-..-.-...:~$ docker run -it --name myweb -p 8005:80 ubuntu:14.04 bash
docker: permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Post "http://%2Fvar%2Frun%2Fdocker.sock/v1.24/containers/create?name=myweb": dial unix /var/run/docker.sock: connect: permission denied.
# ê¶Œí•œ ë³€ê²½í•´ì¤˜ì•¼ í•¨
ubuntu@ip-...-..-.-...:~$ sudo chmod 666 /var/run/docker.sock
ubuntu@ip-...-..-.-...:~$ docker run -it --name myweb -p 8005:80 ubuntu:14.04 bash
# ì»¨í…Œì´ë„ˆ ì§„ì…
root@e7bbb006de5d:/# apt-get update
root@e7bbb006de5d:/# apt-get install -y apache2
root@e3f66c630dd1:/# service apache2 start
... ë‹¤ë¥¸ í„°ë¯¸ë„ ì°½ ì˜¤í”ˆ

ubuntu@ip-...-..-.-...:~$ curl localhost:8005
```

![](img.png)

```bash
root@e3f66c630dd1:/# mv /var/www/html/index.html /var/www/html/index.html.org
root@e3f66c630dd1:/# vi /var/www/html/index.html

<h1> Hello, Docker application. </h1>

...
# ë‘ë²ˆì§¸ í„°ë¯¸ë„
ubuntu@ip-...-..-.-...:~$ curl localhost:8005
<h1> Hello, Docker application. </h1>

# ë‹¤ì‹œ ì²«ë²ˆì§¸ í„°ë¯¸ë„

root@e3f66c630dd1:/# apt-get -y install php5
root@e3f66c630dd1:/# vi /var/www/html/index.php

...
<?php
    phpinfo();
?>
...

root@e3f66c630dd1:/# service apache2 restart

#ë‘ë²ˆì§¸ í„°ë¯¸ë„
ubuntu@ip-...-..-.-...:~$ curl localhost:8005/index.php
```
![](img_1.png)

```bash

#ì²«ë²ˆì§¸ í„°ë¯¸ë„
ubuntu@ip-...-..-.-...:~$ docker commit myweb myphpapp:1.0
sha256:b6e5aaf3caac377cc228c25170466b509cbeb58b6880d208b0c53da216fe9e4b
ubuntu@ip-...-..-.-...:~$ docker images
REPOSITORY   TAG       IMAGE ID       CREATED         SIZE
myphpapp     1.0       b6e5aaf3caac   3 seconds ago   242MB
ubuntu       14.04     13b66b487594   23 months ago   197MB
ubuntu@ip-...-..-.-...:~$ docker run -itd -p 8006:80 --name=phpapp myphpapp:1.0
ce1b36263d790c5bc896245e9eb4b0c6f81f2f30cb1f91b7962306567ba45984
ubuntu@ip-...-..-.-...:~$ docker exec -it phpapp bash
root@ce1b36263d79:/# service apache2 start

#ë‘ë²ˆì§¸ í„°ë¯¸ë„
ubuntu@ip-...-..-.-...:~$ curl localhost:8006
<h1> Hello, Docker application. </h1>
```